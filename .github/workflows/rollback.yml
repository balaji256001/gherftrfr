rollback:
  runs-on: ubuntu-latest
  if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.rollback_version }}
  steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup SSH
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        mkdir -p ~/.ssh
        ssh-keyscan -t ecdsa 44.202.19.252 >> ~/.ssh/known_hosts

    - name: Download specified artifact version from S3
      run: |
        specified_artifact="s3://arti-storage/${{ secrets.FMP_REGION }}/${{ secrets.FMP_ENV }}/fmp-advisor-cms-${{ github.event.inputs.rollback_version }}.zip"
        aws s3 cp $specified_artifact ./artifact-folder/

    - name: Deploy to EC2 instance
      run: |
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo chown -R ubuntu:ubuntu /var/www/html/; sudo chmod -R 775 /var/www/html/; sudo mkdir -p /var/www/html/wp-content/themes; sudo chown -R ubuntu:ubuntu /var/www/html/wp-content/themes; sudo chmod -R 775 /var/www/html/wp-content/themes"
        rsync -avz --delete --exclude='.git*' --exclude='.env' --exclude='.github' -e 'ssh -i private_key.pem -o StrictHostKeyChecking=no' --chmod=D2775,F664 --chown=ubuntu:ubuntu ./artifact-folder/ ubuntu@44.202.19.252:/var/www/html/wp-content/themes/
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "unzip -o \$(ls /var/www/html/wp-content/themes/*.zip | tail -n 1) -d /var/www/html/wp-content/themes/"
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "ls -la /var/www/html/wp-content/themes/custom_packages"  # Add this line
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo rm -f /var/www/html/index.html"
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo cp /var/www/html/wp-content/themes/custom_packages/index.html /var/www/html/"
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo chown -R www-data:www-data /var/www/html/; sudo chmod -R 755 /var/www/html/"

    - name: Run scripts on EC2 instance
      run: |
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo systemctl stop apache2"
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo systemctl start apache2"
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@44.202.19.252 "sudo chown -R www-data:www-data /var/www/html/; sudo chmod -R 755 /var/www/html/"
